name: Build Firmware

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Initialize Environment
        run: |
          df -hT .
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3-setuptools rsync swig unzip zlib1g-dev file wget qemu-utils
          sudo timedatectl set-timezone "Asia/Shanghai"

      - name: Checkout Code
        uses: actions/checkout@v5
      
      - name: Setup Feeds
        working-directory: /home/runner/work/BoltWrt/BoltWrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

          # 修改 LuCI 默认主题路径
          sed -i "s#/luci-static/bootstrap#/luci-static/argon#" feeds/luci/modules/luci-base/root/etc/config/luci

          # 修正 luci-nginx 集合包的依赖
          sed -i -E "s/[[:space:]]*\+luci-theme-bootstrap//" feeds/luci/collections/luci-nginx/Makefile

      - name: Build Firmware
        id: build
        working-directory: /home/runner/work/BoltWrt/BoltWrt
        run: |
          echo "Normalizing build configuration..."
          mv config.txt .config
          make defconfig

          echo "Downloading feeds..."
          make download -j6 || (echo "❌ Failed to download feeds" && exit 1)

          echo "Using $(nproc) processors for building"
          make -j $(($(nproc)+1)) || make -j1 V=s

          echo "Build completed successfully."
          df -hT .
      
      - name: Upload Firmware Artifacts
        if: (!cancelled())
        uses: actions/upload-artifact@v4
        with:
          name: BoltWrt-Firmware
          path: |
            bin/targets/x86/64/boltwrt-x86-64-generic-squashfs-combined.img.gz
            bin/targets/x86/64/boltwrt-x86-64-generic-squashfs-combined-efi.img.gz
            bin/targets/x86/64/boltwrt-x86-64-generic-squashfs-combined.vmdk
            bin/targets/x86/64/boltwrt-x86-64-generic-squashfs-combined-efi.vmdk
            bin/targets/x86/64/boltwrt-x86-64-generic.manifest
            bin/targets/x86/64/config.buildinfo
            bin/targets/x86/64/feeds.buildinfo
            bin/targets/x86/64/version.buildinfo
            bin/targets/x86/64/profiles.json
            bin/targets/x86/64/sha256sums

      - name: Upload SDK Artifacts
        if: (!cancelled())
        uses: actions/upload-artifact@v4
        with:
          name: BoltWrt-SDK
          path: bin/targets/x86/64/boltwrt-sdk-x86-64_*.tar.zst
