name: Build Firmware

on:
  workflow_dispatch:
    inputs:
      config_file_url:
        description: 'Config file URL'
        required: true

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Initialize Environment
        run: |
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3-setuptools rsync swig unzip zlib1g-dev file wget
          sudo timedatectl set-timezone "Asia/Shanghai"
          sudo chown -R boltwrt:boltwrt /home/runner/work/BoltWrt/BoltWrt
          sudo chmod -Rf 755 /home/runner/work/BoltWrt/BoltWrt
          cd /home/runner/work/BoltWrt/BoltWrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          curl -o .config "${{ github.event.inputs.config_file_url }}"
          make defconfig
          make download -j8

      - name: Cross Compile
        run: |
          cd /home/runner/work/BoltWrt/BoltWrt

          echo "$(nproc) threads detected"
          make -j $(($(nproc)+1)) || make -j1 V=s